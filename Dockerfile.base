# Base image with kali-linux-headless pre-installed
# Build once, push to mayflowergmbh/kali-ai-redteam-base:latest
# Rebuild only when Kali packages need updating

FROM kalilinux/kali-rolling

ENV DEBIAN_FRONTEND=noninteractive

# Make RUN steps fail fast and surface errors in pipelines.
SHELL ["/bin/bash", "-euxo", "pipefail", "-c"]

# Install kali-linux-headless metapackage (this is the slow part ~25-35 min)
RUN apt-get update && \
    apt-get -y full-upgrade && \
    apt-get -y install kali-linux-headless && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install additional dependencies needed by the main image
RUN apt-get update && \
    apt-get -y install \
      ca-certificates \
      cargo \
      crackmapexec \
      dirsearch \
      curl \
      feroxbuster \
      fish \
      git \
      gitleaks \
      jq \
      kubectl \
      kubernetes-helm \
      naabu \
      nodejs \
      npm \
      nuclei \
      bloodhound.py \
      python3-pip \
      python3-venv \
      pipx \
      ripgrep \
      rustc \
      subfinder \
      sudo \
      syft \
      trivy \
      yq && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install grype (not packaged in Kali at the moment).
RUN curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

# Install promptfoo + MCP servers globally (avoid npx cold-start downloads).
RUN npm install -g \
      promptfoo@latest \
      mcp-chat@latest \
      mcp-server-kubernetes@latest \
      mcp-server-sqlite@latest

# Install Playwright system dependencies
RUN npx -y playwright@latest install-deps chromium

# Install Python libraries in a dedicated venv (avoid mutating distro Python).
ENV VIRTUAL_ENV=/opt/ai-venv
ENV PATH="${VIRTUAL_ENV}/bin:${PATH}"
RUN python3 -m venv "${VIRTUAL_ENV}" && \
    "${VIRTUAL_ENV}/bin/pip" install --no-cache-dir -U pip setuptools wheel && \
    "${VIRTUAL_ENV}/bin/pip" install --no-cache-dir -U \
      adversarial-robustness-toolbox \
      instructor \
      httpx \
      openai \
      anthropic
